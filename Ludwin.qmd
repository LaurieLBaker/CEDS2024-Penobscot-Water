---
title: "Field Report test"
date: today
format:
  html:
    embed-resources: true
    number_sections: true
    toc: true
format-links: false
execute:
  echo: false
  warning: false
params:
  individual_collector: "DHK"
  SiteVisitID: current_SiteVisitID
  RunCode: current_RunCode
  RunDate: current_RunDate
  SiteCode: current_SiteCode
---

Collector: **`r params$individual_collector`**

```{r setup, include=FALSE}
library(readr)
library(here)
library(dplyr)
library(ggplot2)
library(stringr)
library(purrr)
library(knitr)
library(gt)
library(kableExtra)
library(tidyr)

data2018 <- readRDS("data/PINCommEngData (2).RData")

data2018 <-  data2018 %>%
  mutate(RunDate = format(as.Date(RunDate), "%m-%d-%Y")) 

data2018_subset <- data2018 %>% filter(str_detect(Collectors, fixed(params$individual_collector)))

data2018_subset <- data2018_subset %>%
  arrange(SiteVisitID)

duplicates <- data2018_subset[duplicated(data2018_subset$SiteVisitID), ]

if (nrow(duplicates) > 0) {
  combined_data <- data2018_subset[!duplicated(data2018_subset$SiteVisitID), ]
}

combined_data <- combined_data %>%
  select(SiteVisitID, RunDate, RunCode, SiteCode) %>% 
  unique()

combined_data <- apply(combined_data, 1, as.list)

```


```{r}
#| results: hide

unique_collectors <- unique(data2018$Collectors)

split_collectors <- strsplit(unique_collectors, ";")

individual_values <- unlist(split_collectors)

individual_values <- gsub("\\s+", "", individual_values)

individual_collectors <- unique(individual_values) 

SiteVisitID <- data2018_subset %>% 
  filter(str_detect(Collectors, fixed(params$individual_collector))) |> 
  distinct(SiteVisitID) %>% 
  pull()

RunDate <- data2018_subset %>% 
  filter(str_detect(Collectors, fixed(params$individual_collector))) |> 
  distinct(RunDate) %>% 
  pull()

RunCode <- data2018_subset %>%
  filter(str_detect(Collectors, fixed(params$individual_collector))) |> 
  distinct(RunCode) %>% 
  pull()

SiteCode <- data2018_subset %>%
  filter(str_detect(Collectors, fixed(params$individual_collector))) |> 
  distinct(SiteCode) %>% 
  pull()

```



```{r}
#| output: asis

SiteVisitID_Sections <- map_chr(seq_along(combined_data), \(i) {
  current_data <- combined_data[[i]]

  current_SiteVisitID <- current_data$SiteVisitID
  current_RunDate <- current_data$RunDate
  current_RunCode <- current_data$RunCode
  current_SiteCode <- current_data$SiteCode

  section_title <- paste("RunDate:", current_RunDate, "RunCode:", current_RunCode, "SiteCode:", current_SiteCode)

  params_env <- new.env(parent = emptyenv())
  params_env$SiteVisitID <- current_SiteVisitID
  params_env$RunDate <- current_RunDate
  params_env$RunCode <- current_RunCode
  params_env$SiteCode <- current_SiteCode

  child_output <- knitr::knit_child(
    input = "child_doc_lud_2.qmd",
    envir = params_env,
    quiet = TRUE
  )

  paste(section_title, child_output, sep = "\n")
})

cat(SiteVisitID_Sections, sep = "\n")
```
